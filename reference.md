# Necro Reference Guide

Complete templates, procedures, and technical details for Necro operations.

## File Templates

### .necro/config.json

```json
{
  "version": "1.0.0",
  "initialized": "2025-01-04 09:30:00",
  "project_root": "/path/to/project",
  "deprecated_retention_days": 30,
  "inventory_settings": {
    "ignore_dirs": [
      "node_modules",
      ".git",
      "dist",
      "build",
      "deprecated",
      ".necro",
      "__pycache__",
      "venv",
      ".venv",
      "vendor",
      "target",
      ".next",
      ".nuxt",
      "coverage",
      ".cache"
    ],
    "suspicious_patterns": [
      "*-old.*",
      "*-old",
      "*_old.*",
      "*_old",
      "*-backup.*",
      "*-backup",
      "*_backup.*",
      "*_backup",
      "*.bak",
      "*-copy.*",
      "*-copy",
      "*_copy.*",
      "*_copy",
      "*.old",
      "*-deprecated.*",
      "*-deprecated",
      "*.orig",
      "*~",
      "*.tmp",
      "*-temp.*",
      "*-temp",
      "*_temp.*",
      "*_temp"
    ],
    "stale_days": 30
  },
  "test_command": null
}
```

**Field Descriptions:**
| Field | Type | Description |
|-------|------|-------------|
| `version` | string | Necro config version |
| `initialized` | string | DateTime when Necro was set up |
| `project_root` | string | Absolute path to project root |
| `deprecated_retention_days` | number | Days before files can be permanently deleted |
| `inventory_settings.ignore_dirs` | array | Directories to skip during scans |
| `inventory_settings.suspicious_patterns` | array | Glob patterns for potential zombie files |
| `inventory_settings.stale_days` | number | Days of inactivity to flag as stale |
| `test_command` | string/null | Optional test command to run |

---

### deprecated/DEPRECATION_LOG.md

```markdown
# Deprecation Log

This file tracks all deprecated files in this project. Files are moved to dated
folders within `deprecated/` and retained for the configured retention period
(default: 30 days) before permanent deletion is allowed.

## How to Use This Log

1. **Before referencing old code:** Check if the file path appears here
2. **Finding replacement:** Look in the "Replacement" column
3. **Understanding why:** Read the "Reason" column
4. **Cleanup:** Files past their "Delete After" date can be permanently removed

---

## Deprecation Records

| Date | Original Path | Archive Location | Reason | Replacement | Delete After |
|------|---------------|------------------|--------|-------------|--------------|

---

## Deleted Records

Files that have been permanently deleted after retention period:

| Deleted Date | Original Path | Reason | Was Replaced By |
|--------------|---------------|--------|-----------------|
```

---

### ARCHITECTURE.md

```markdown
# Project Architecture

> **Last Updated:** 2025-01-04 09:30:00
> **Generated by:** Necro - Project Archaeology System

---

## AI Assistant Instructions

**CRITICAL:** When working in this project:
1. **ONLY** reference files listed in the "Active Files" sections below
2. **NEVER** reference or suggest edits to anything in `/deprecated/`
3. **CHECK** this document when unsure if a file is current
4. **UPDATE** this document after adding/removing files

If you encounter a file not listed here, check `deprecated/DEPRECATION_LOG.md`
to see if it was deprecated and what replaced it.

---

## Project Structure

```
[PROJECT_NAME]/
├── src/
│   └── ...
├── tests/
│   └── ...
├── docs/
│   └── ...
├── deprecated/          # DO NOT USE - archived files only
│   └── DEPRECATION_LOG.md
├── .necro/
│   └── config.json
└── ARCHITECTURE.md      # This file
```

---

## Active Source Files

### Core Application
<!-- List main source files here -->

### Components
<!-- List component files here -->

### Utilities
<!-- List utility/helper files here -->

### Configuration
<!-- List config files here -->

---

## Scripts & Commands

### Package Scripts
<!-- From package.json if applicable -->

### Shell Scripts
<!-- List .sh files -->

---

## Documentation

<!-- List .md files excluding this one and deprecated/ -->

---

## Git Information

- **Branch:** main
- **Remote:** [repository URL]
- **Status:** [clean/dirty]

---

## Deprecated Files

For a complete list of deprecated files and their replacements, see:
`deprecated/DEPRECATION_LOG.md`

**Remember:** Files in `deprecated/` are archived for reference only.
Do not modify or reference them in active development.

---

## Maintenance

This file should be updated when:
- New files are added to the project
- Files are deprecated (removed from active sections)
- Project structure changes significantly
- Before starting a new development session with AI assistance
```

---

## Procedures

### Procedure: Initialize Necro

**When:** User asks to set up Necro, or entering project without `.necro/`

**Steps:**

1. **Confirm with user:**
   ```
   "I'll initialize Necro in this project. This creates:
   - .necro/config.json (settings)
   - deprecated/ folder (archive)
   - ARCHITECTURE.md (active file map)

   Proceed?"
   ```

2. **Create .necro directory:**
   ```
   mkdir .necro
   ```

3. **Create config.json:**
   - Use template above
   - Set `initialized` to current datetime
   - Set `project_root` to current directory path

4. **Create deprecated directory:**
   ```
   mkdir deprecated
   ```

5. **Create DEPRECATION_LOG.md:**
   - Use template above

6. **Generate ARCHITECTURE.md:**
   - Run architecture generation procedure

7. **Report completion:**
   ```
   "Necro initialized! I've created:
   ✓ .necro/config.json
   ✓ deprecated/DEPRECATION_LOG.md
   ✓ ARCHITECTURE.md

   I'll now track this project's structure and help manage deprecated files."
   ```

---

### Procedure: Deprecate a File

**When:** Replacing a file, removing unused code, or user requests deprecation

**Steps:**

1. **Get current date:**
   - Format: YYYY-MM-DD (e.g., 2025-01-04)

2. **Calculate delete-after date:**
   - Current date + retention_days from config (default 30)

3. **Create dated archive folder:**
   ```
   deprecated/YYYY-MM-DD/
   ```

4. **Preserve directory structure:**
   - If file is at `src/utils/helper.js`
   - Archive to `deprecated/YYYY-MM-DD/src/utils/helper.js`

5. **Move the file:**
   - Use file system move (not copy)
   - Original location should no longer exist

6. **Update DEPRECATION_LOG.md:**
   - Add new row with all fields
   - Reason should explain WHY deprecated
   - Replacement should point to new file (or "N/A - removed")

7. **Update ARCHITECTURE.md:**
   - Remove file from active sections
   - Regenerate if significant changes

8. **Report to user:**
   ```
   "Deprecated: src/utils/helper.js
   ├─ Archived to: deprecated/2025-01-04/src/utils/helper.js
   ├─ Reason: [reason]
   ├─ Replacement: [new file or N/A]
   └─ Will be deletable after: 2025-02-03"
   ```

---

### Procedure: Generate Architecture

**When:** After init, after deprecations, when user asks, or periodically

**Steps:**

1. **Scan project structure:**
   - Use Glob to find all files
   - Exclude directories from `ignore_dirs` in config
   - Build tree representation (3 levels deep)

2. **Categorize active files:**
   - Source files by directory (src/, lib/, app/, etc.)
   - Test files (tests/, __tests__/, *.test.*, *.spec.*)
   - Config files (*.config.*, .env*, etc.)
   - Documentation (*.md excluding deprecated/)
   - Scripts (.sh, .ps1, package.json scripts)

3. **Gather git information:**
   - Current branch
   - Remote URL (if available)
   - Working tree status

4. **Build ARCHITECTURE.md:**
   - Use template structure
   - Fill in categorized files
   - Set current timestamp

5. **Write file:**
   - Overwrite existing ARCHITECTURE.md
   - Report changes made

---

### Procedure: Inventory Scan

**When:** Entering project, user asks for cleanup, or proactively

**Steps:**

1. **Load config:**
   - Read `.necro/config.json`
   - Get `suspicious_patterns` and `stale_days`

2. **Scan for suspicious filenames:**
   - Glob each pattern in `suspicious_patterns`
   - Exclude files already in `deprecated/`

3. **Scan for stale files:**
   - Find files not modified in `stale_days`
   - Focus on source directories
   - Exclude dependencies and build artifacts

4. **Check for orphaned files:**
   - Tests without corresponding source
   - Configs for removed features

5. **Build report:**
   ```markdown
   ## Necro Inventory Scan Results

   ### Suspicious Filenames (X files)
   - `path/to/file-old.js` - matches *-old.*

   ### Stale Files (X files, >30 days)
   - `path/to/unused.js` - 45 days since modified

   ### Potential Orphans (X files)
   - `tests/removed-feature.test.js` - no matching source

   ### Recommended Actions
   1. Review suspicious files for deprecation
   2. Verify stale files are still needed
   3. Check orphans against current features
   ```

6. **Offer to deprecate:**
   - Ask user which files to deprecate
   - Process deprecations if confirmed

---

### Procedure: Clean Deprecated

**When:** User asks to clean old files, or during maintenance

**Steps:**

1. **Read DEPRECATION_LOG.md:**
   - Parse the table for all entries
   - Extract "Delete After" dates

2. **Find eligible files:**
   - Compare "Delete After" to current date
   - Files where current date >= delete after are eligible

3. **List for confirmation:**
   ```
   "These deprecated files are past their retention period:

   1. deprecated/2024-12-01/src/old-file.js (delete after: 2024-12-31)
   2. deprecated/2024-12-05/lib/unused.js (delete after: 2025-01-04)

   Permanently delete these files? This cannot be undone."
   ```

4. **If confirmed:**
   - Delete each file
   - Move entry from main table to "Deleted Records" section
   - Add deletion date
   - Clean up empty dated folders

5. **Report:**
   ```
   "Cleaned 2 deprecated files:
   ✓ Deleted: deprecated/2024-12-01/src/old-file.js
   ✓ Deleted: deprecated/2024-12-05/lib/unused.js
   ✓ Updated DEPRECATION_LOG.md"
   ```

---

## Glob Patterns Reference

### Finding Suspicious Files
```
*-old.*        # file-old.js
*_old.*        # file_old.js
*-backup.*     # config-backup.json
*.bak          # file.bak
*-copy.*       # component-copy.tsx
*.orig         # file.orig (git merge artifacts)
*~             # file~ (editor backups)
```

### Finding Source Files
```
**/*.js        # JavaScript
**/*.ts        # TypeScript
**/*.jsx       # React JSX
**/*.tsx       # React TSX
**/*.py        # Python
**/*.go        # Go
**/*.rs        # Rust
**/*.rb        # Ruby
**/*.php       # PHP
**/*.java      # Java
**/*.cs        # C#
**/*.cpp       # C++
**/*.c         # C
**/*.swift     # Swift
**/*.kt        # Kotlin
```

### Finding Config Files
```
**/*.config.*  # webpack.config.js, etc.
**/*.json      # JSON configs
**/*.yaml      # YAML configs
**/*.yml       # YAML configs
**/*.toml      # TOML configs
**/.*rc        # .eslintrc, .prettierrc
**/.*rc.*      # .eslintrc.json
```

---

## Date Handling

### Format Standards
- **Date only:** `YYYY-MM-DD` (2025-01-04)
- **DateTime:** `YYYY-MM-DD HH:MM:SS` (2025-01-04 09:30:00)
- **Folder names:** `YYYY-MM-DD` only

### Calculating Future Dates
- Retention period: Add `deprecated_retention_days` from config
- Default: 30 days
- Example: Deprecated 2025-01-04 → Delete after 2025-02-03

### Timezone
- Use local system timezone
- Be consistent within a project

---

## Error Handling

### File Not Found
```
"Cannot deprecate: [path] does not exist.
Did you mean one of these?
- [similar path 1]
- [similar path 2]"
```

### Already Deprecated
```
"[path] is already in deprecated/.
Check DEPRECATION_LOG.md for details."
```

### Config Missing
```
"Necro is not initialized in this project.
Run initialization first? (creates .necro/, deprecated/, ARCHITECTURE.md)"
```

### Permission Denied
```
"Cannot write to [path]. Check file permissions.
You may need to run with elevated privileges."
```
